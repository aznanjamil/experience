{"version":3,"file":"openClose.js","sourceRoot":"","sources":["../../../../src/tests/commonTests/openClose.ts"],"names":[],"mappings":"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","sourcesContent":["import { E2EPage } from \"@stencil/core/testing\";\nimport { toHaveNoViolations } from \"jest-axe\";\nimport { GlobalTestProps, newProgrammaticE2EPage, skipAnimations } from \"../utils\";\nimport { getTag, simplePageSetup } from \"./utils\";\nimport { TagOrHTML } from \"./interfaces\";\n\nexpect.extend(toHaveNoViolations);\n\ninterface BeforeToggle {\n  /**\n   * Function argument to simulate user input (mouse or keyboard), to open the component.\n   */\n  open: (page: E2EPage) => Promise<void>;\n\n  /**\n   * Function argument to simulate user input (mouse or keyboard), to close the component.\n   */\n  close: (page: E2EPage) => Promise<void>;\n}\n\ninterface OpenCloseOptions {\n  /**\n   * Toggle property to test. Currently, either \"open\" or \"expanded\".\n   */\n  openPropName?: string;\n\n  /**\n   * Indicates the initial value of the toggle property.\n   */\n  initialToggleValue?: boolean;\n\n  /**\n   * Optional argument with functions to simulate user input (mouse or keyboard), to open or close the component.\n   */\n  beforeToggle?: BeforeToggle;\n}\n\n/**\n * Helper to test openClose component setup.\n *\n * Note that this helper should be used within a `describe` block.\n *\n * @example\n *\n * describe(\"openClose\", () => {\n *   openClose(\"calcite-combobox opened with a tab\", {\n *     beforeToggle: {\n *        open: async (page) => {\n *            await page.keyboard.press(\"Tab\");\n *            await page.waitForChanges();\n *        },\n *        close: async (page) => {\n *            await page.keyboard.press(\"Tab\");\n *            await page.waitForChanges();\n *        },\n *      }\n *   });\n *\n *  openClose(\"open calcite-combobox closed with a tab\", {\n *        initialToggleValue: true,\n *        beforeToggle: {\n *          close: async (page) => {\n *            await page.keyboard.press(\"Tab\");\n *            await page.waitForChanges();\n *        },\n *      }\n *    }\n * })\n *\n * @param componentTagOrHTML - The component tag or HTML markup to test against.\n * @param {object} [options] - Additional options to assert.\n */\n\nexport function openClose(componentTagOrHTML: TagOrHTML, options?: OpenCloseOptions): void {\n  const defaultOptions: OpenCloseOptions = {\n    initialToggleValue: false,\n    openPropName: \"open\",\n  };\n  const customizedOptions = { ...defaultOptions, ...options };\n\n  type EventOrderWindow = GlobalTestProps<{ events: string[] }>;\n  const eventSequence = setUpEventSequence(componentTagOrHTML);\n\n  function setUpEventSequence(componentTagOrHTML: TagOrHTML): string[] {\n    const tag = getTag(componentTagOrHTML);\n\n    const camelCaseTag = tag.replace(/-([a-z])/g, (lettersAfterHyphen) => lettersAfterHyphen[1].toUpperCase());\n    const eventSuffixes = [`BeforeOpen`, `Open`, `BeforeClose`, `Close`];\n\n    return eventSuffixes.map((suffix) => `${camelCaseTag}${suffix}`);\n  }\n\n  async function setUpPage(componentTagOrHTML: TagOrHTML, page: E2EPage): Promise<void> {\n    await page.evaluate(\n      (eventSequence: string[], initialToggleValue: boolean, openPropName: string, componentTagOrHTML: string) => {\n        const receivedEvents: string[] = [];\n\n        (window as EventOrderWindow).events = receivedEvents;\n\n        eventSequence.forEach((eventType) => {\n          document.addEventListener(eventType, (event) => receivedEvents.push(event.type));\n        });\n\n        if (!initialToggleValue) {\n          return;\n        }\n\n        const component = document.createElement(componentTagOrHTML);\n        component[openPropName] = true;\n\n        document.body.append(component);\n      },\n      eventSequence,\n      customizedOptions.initialToggleValue,\n      customizedOptions.openPropName,\n      componentTagOrHTML,\n    );\n  }\n\n  async function testOpenCloseEvents(componentTagOrHTML: TagOrHTML, page: E2EPage): Promise<void> {\n    const tag = getTag(componentTagOrHTML);\n    const element = await page.find(tag);\n\n    const [beforeOpenEvent, openEvent, beforeCloseEvent, closeEvent] = eventSequence.map((event) =>\n      page.waitForEvent(event),\n    );\n\n    const [beforeOpenSpy, openSpy, beforeCloseSpy, closeSpy] = await Promise.all(\n      eventSequence.map(async (event) => await element.spyOnEvent(event)),\n    );\n\n    await page.waitForChanges();\n\n    if (customizedOptions.beforeToggle) {\n      await customizedOptions.beforeToggle.open(page);\n    } else {\n      element.setProperty(customizedOptions.openPropName, true);\n    }\n\n    await page.waitForChanges();\n\n    await beforeOpenEvent;\n    await openEvent;\n\n    expect(beforeOpenSpy).toHaveReceivedEventTimes(1);\n    expect(openSpy).toHaveReceivedEventTimes(1);\n    expect(beforeCloseSpy).toHaveReceivedEventTimes(0);\n    expect(closeSpy).toHaveReceivedEventTimes(0);\n\n    if (customizedOptions.beforeToggle) {\n      await customizedOptions.beforeToggle.close(page);\n    } else {\n      element.setProperty(customizedOptions.openPropName, false);\n    }\n\n    await page.waitForChanges();\n\n    await beforeCloseEvent;\n    await closeEvent;\n\n    expect(beforeCloseSpy).toHaveReceivedEventTimes(1);\n    expect(closeSpy).toHaveReceivedEventTimes(1);\n    expect(beforeOpenSpy).toHaveReceivedEventTimes(1);\n    expect(openSpy).toHaveReceivedEventTimes(1);\n\n    expect(await page.evaluate(() => (window as EventOrderWindow).events)).toEqual(eventSequence);\n  }\n\n  /**\n   * `skipAnimations` utility sets the animation duration to 0.01. This is a workaround for an issue with the animation utility.\n   * Because this still leaves a very small duration, we can still test the animation events, but faster.\n   */\n\n  if (customizedOptions.initialToggleValue === true) {\n    it(\"emits on initialization with animations enabled\", async () => {\n      const page = await newProgrammaticE2EPage();\n      await skipAnimations(page);\n      await setUpPage(componentTagOrHTML, page);\n      await testOpenCloseEvents(componentTagOrHTML, page);\n    });\n\n    it(\"emits on initialization with animations disabled\", async () => {\n      const page = await newProgrammaticE2EPage();\n      await page.addStyleTag({\n        content: `:root { --calcite-duration-factor: 0; }`,\n      });\n      await setUpPage(componentTagOrHTML, page);\n      await testOpenCloseEvents(componentTagOrHTML, page);\n    });\n  } else {\n    it(`emits with animations enabled`, async () => {\n      const page = await simplePageSetup(componentTagOrHTML);\n      await skipAnimations(page);\n      await setUpPage(componentTagOrHTML, page);\n      await testOpenCloseEvents(componentTagOrHTML, page);\n    });\n\n    it(`emits with animations disabled`, async () => {\n      const page = await simplePageSetup(componentTagOrHTML);\n      await page.addStyleTag({\n        content: `:root { --calcite-duration-factor: 0; }`,\n      });\n      await setUpPage(componentTagOrHTML, page);\n      await testOpenCloseEvents(componentTagOrHTML, page);\n    });\n  }\n}\n"]}