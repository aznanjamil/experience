/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import"../../intl.js";import{isSome as e}from"../../core/arrayUtils.js";import{neverReached as t}from"../../core/compilerUtils.js";import{equalsShallow as n}from"../../core/lang.js";import r from"../../core/Logger.js";import{templateHasKey as o,replace as i}from"../../core/string.js";import{isFieldElement as s}from"../../form/support/formUtils.js";import{DomainValidationError as l}from"../../layers/support/domainUtils.js";import{isTimeOnlyField as u,NumericRangeValidationError as a,TypeValidationError as p}from"../../layers/support/fieldUtils.js";import{isAnyDateField as m}from"../../smartMapping/support/utils.js";import{getLabelForDateFieldValue as d,getIntlOptionsForField as c}from"../support/dateUtils.js";import{substitute as f}from"../../intl/substitute.js";const y=e=>"field"===e?.type,b=e=>"group"===e?.type,g=e=>"relationship"===e?.type,x=e=>"text"===e.type,T=e=>!b(e)&&null!=e.group,O=e=>e.reduce(((e,t)=>b(t)?[...e,...t.inputs]:[...e,t]),[]),j=e=>O(e).filter(y),h=e=>O(e).filter(g),v=e=>null!=e&&(E(e,"combo-box")||E(e,"radio-buttons")),E=(e,t)=>null!=e&&e.input?.type===t,V=e=>null!=e&&(E(e,"text-box")||E(e,"text-area")),N=({domain:e,inputType:t="text-box",dataType:n})=>"number"===n&&"text-box"===t&&(!e||"coded-value"!==e.type),F=e=>"items"in e,U={typeFieldName:null,types:[]};function L(t){const{attributes:n,fieldsIndex:r,label:i,timeZone:s}=t;if(!n||"object"!=typeof n)return i;const l=Object.keys(n).filter((e=>o(i,e))),u=l.map((e=>n[e])),a=l.map((e=>r.get(e))).filter(e);return C(i,Z({values:u,fields:a,timeZone:s}))}const _="expression/",A="expr/",I="field/";function R(e){const[t,n]=e.split(_);return""===t&&n?n:(r.getLogger("esri.widgets.FeatureForm/featureFormUtils").error("extractExpressionNameFromString:invalid-input",`The string ${e} is not a valid expression reference of the form '${_}/expressionName'`),"")}function $(e){return`${_}${e}`}function D(e){return`${I}${e}`}function w(e){return e.startsWith(_)}function S(e){return e.startsWith(A)}function Z(e){const{fields:t,values:n}=e,r=e.timeZone??void 0,o=t.map(((e,t)=>{let o=n[t];if(e.domain&&"coded-value"===e.domain.type){const t=e.domain.codedValues.find((e=>e.code===o));t?.name&&(o=t.name)}return(m(e)||u(e))&&(o=d(e,o,{timeZone:r,...c(e)})),[e.name,o]}));return Object.fromEntries(o)}function C(e,t){return i(i(e,(e=>`{${e.toLowerCase()}}`)),Object.fromEntries(Object.entries(t).map((([e,t])=>[e.toLowerCase(),t]))))}const G=e=>e?"subtype-sublayer"===e.type?{typeFieldName:e.parent?.subtypeField,types:e.parent?.subtypes??[]}:"feature"===e.type&&e.subtypes?.length?{typeFieldName:e.subtypeField,types:e.subtypes}:"types"in e&&e.types?{typeFieldName:e.typeIdField,types:e.types.map((({id:e,name:t,domains:n})=>({code:e,name:t,domains:n})))}:U:U,M=(e,t)=>{if(!e)return!0;const{operations:n}=e;switch(t){case"INSERT":return n.supportsAdd;case"UPDATE":case"DELETE":return n.supportsUpdate;default:return!0}};var H;!function(e){e.TOO_SHORT="length-validation-error::too-short",e.TOO_LONG="length-validation-error::too-long"}(H||(H={}));const P={type:"number"},W={type:"number",intlOptions:{notation:"scientific"}};function k(e){return e>=1e7||e<=-1e7}function q(e,{validationErrors:t}){return null!=e.max&&null!=e.min?t.outsideRange:null!=e.max?t.outsideRangeMax:t.outsideRangeMin}const B=(e,t,n)=>{const{dataType:r,error:o,minLength:i,value:s,required:u}=e,m=t?.validationErrors;if(!m||!o)return null;if(u&&null===s)return m.cannotBeNull;if(o===l.VALUE_OUT_OF_RANGE||o===a.OUT_OF_RANGE){const{field:o,range:i}=e,s={type:"date",intlOptions:{timeZone:"date"===o.type&&n?n:void 0,...c(o)}},l=q(i,t);return f(l,i,{format:{max:"date"===r?s:null!=i.max&&k(i.max)?W:P,min:"date"===r?s:null!=i.min&&k(i.min)?W:P}})}return o===l.INVALID_CODED_VALUE?m.invalidCodedValue:o===p.INVALID_TYPE?m.invalidType:o===H.TOO_SHORT?f(m.tooShort,{min:i}):(H.TOO_LONG,null)},Y=e=>{if(!e)return;const t=e.layer,n=t&&"geometryType"in t?t.geometryType:void 0,r=e.geometry?.type;return"polyline"===r||"polyline"===n?"line":"mesh"===r||"mesh"===n||"multipatch"===n?"cube":"multipoint"===r||"multipoint"===n?"point":r||n||"table"},z=e=>{const t=[];if(e.formTemplate){const{description:n,title:r}=e.formTemplate;e.fields?.forEach((e=>{const i=r&&o(r,e.name),s=n&&o(n,e.name);(i||s)&&t.push(e.name)}))}return t};function J(e,t){const n=t??("formTemplate"in e&&e.formTemplate);if(n){return(n.elements?.filter(s)??[]).some((({fieldName:t})=>!e.fieldsIndex.get(t)))}return!1}function K(e,t){return null==e||t.onValue!==e&&t.offValue!==e}function Q(e,n){switch(n.objectType){case"any":return!0;case"null":return null==e;case"code":return e===n.codedValue?.code;case"range":return null!=e&&null!=n.minValue&&null!=n.maxValue&&+e>=n.minValue&&+e<=n.maxValue;default:return t(n.objectType),!1}}function X(e,t,r){if(!e||!("subtypes"in e))return!1;const o=e.subtypes?.find((e=>e.code===r));if(!o)return!1;const i=e.subtypes?.find((e=>e.code===t));return!n(o.defaultValues,i?.defaultValues)&&Object.values(o.defaultValues).some((e=>null!=e))}export{H as LengthValidationError,M as capabilitiesAllowEditType,R as extractExpressionNameFromString,j as flattenFieldInputs,O as flattenInputs,h as flattenRelationshipInputs,J as formTemplateHasInvalidFields,Z as getComputedAttributes,B as getErrorMessageForFieldInput,z as getFieldsInTitleAndDesc,Y as getIconForFeature,G as getNormalizedFeatureTypeInfo,w as isExpressionReference,E as isFieldElementWithInputType,v as isFieldElementWithShowNoValueOptionInput,V as isFieldElementWithTextInput,y as isFieldInput,b as isGroupInput,T as isInputInGroupInput,S as isLegacyFieldMapsExpressionReference,N as isNumberFieldInput,g as isRelationshipInput,F as isTemplateItemGroup,x as isTextElementInput,L as parseFormTemplateString,$ as prependExpressionPrefix,D as prependFieldPrefix,C as substituteFieldTemplatesInString,X as subtypeChangeShouldPrompt,K as valueIsInvalidSwitchValue,Q as valueIsValidContingentValue};
